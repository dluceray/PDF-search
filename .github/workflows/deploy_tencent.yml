name: Deploy to Tencent Server (Manual)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/Tag/SHA to deploy (default: Tencent)"
        required: false
        default: "Tencent"

concurrency:
  group: deploy-tencent
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Tencent via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.TENCENT_HOST }}
          username: ${{ vars.TENCENT_USER }}
          port: ${{ vars.TENCENT_PORT }}
          key: ${{ secrets.TENCENT_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            REF="${{ github.event.inputs.ref }}"
            echo "== Deploy ref: ${REF} =="

            cd /root/pdfsearch

            echo "== remotes =="; git remote -v
            echo "== fetch =="; git fetch --prune origin

            echo "== checkout/reset to origin/${REF} =="
            git checkout -B "${REF}" "origin/${REF}"
            git reset --hard "origin/${REF}"

            echo "== optional deps =="
            if [ -f requirements.txt ]; then
              /root/pdfsearch/venv/bin/pip install -r requirements.txt
            fi

            echo "== restart service =="
            systemctl restart pdfsearch
            systemctl status pdfsearch --no-pager -l | sed -n '1,80p'
