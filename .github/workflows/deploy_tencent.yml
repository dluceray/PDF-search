name: Deploy to Tencent Server (Manual)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/Tag/SHA to deploy"
        required: false
        default: "Tencent"

concurrency:
  group: deploy-tencent
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Build deploy package (exclude .git and venv)
        run: |
          set -euo pipefail
          tar --exclude=.git --exclude=venv -czf /tmp/pdfsearch.tgz .

      - name: Upload package to Tencent
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.TENCENT_HOST }}
          username: ${{ vars.TENCENT_USER }}
          port: ${{ vars.TENCENT_PORT }}
          key: ${{ secrets.TENCENT_SSH_KEY }}
          source: "/tmp/pdfsearch.tgz"
          target: "/tmp"

      - name: Deploy on Tencent (extract + restart)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.TENCENT_HOST }}
          username: ${{ vars.TENCENT_USER }}
          port: ${{ vars.TENCENT_PORT }}
          key: ${{ secrets.TENCENT_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            cd /root/pdfsearch
            tar -xzf /tmp/pdfsearch.tgz -C /root/pdfsearch
            systemctl restart pdfsearch
            systemctl is-active --quiet pdfsearch
            echo "DEPLOY_OK"
