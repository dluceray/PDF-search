name: Deploy to Korea Server

on:
  push:
    branches: [ korea ]
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/Tag/SHA to deploy (default: korea)"
        required: false
        default: "korea"

concurrency:
  group: deploy-korea
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_REF: ${{ github.event.inputs.ref || 'korea' }}

    steps:
      - name: Deploy to Korea via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 45.93.30.190
          username: root
          port: 22
          key: ${{ secrets.KOREA_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "== Deploy ref: ${DEPLOY_REF} =="

            cd /root/pdfsearch
            git fetch --all --tags

            # 如果是分支（origin/xxx 存在）就 reset 到远端分支；否则按 tag/SHA 直接 checkout
            if git show-ref --verify --quiet "refs/remotes/origin/${DEPLOY_REF}"; then
              git checkout -f "${DEPLOY_REF}"
              git reset --hard "origin/${DEPLOY_REF}"
            else
              git checkout -f "${DEPLOY_REF}"
            fi

            # 同步前端到 Nginx 站点目录（确保主页可更新）
            command -v rsync >/dev/null 2>&1 || (apt-get update -y && apt-get install -y rsync)
            mkdir -p /var/www/gfwzb.com
            rsync -a --delete /root/pdfsearch/site_frontend/ /var/www/gfwzb.com/
            chmod -R 755 /var/www/gfwzb.com

            # 后端依赖与重启
            source venv/bin/activate
            pip install --no-cache-dir -r requirements.txt
            deactivate

            systemctl restart pdfsearch
            systemctl reload nginx || systemctl restart nginx || true

            echo "== done =="
