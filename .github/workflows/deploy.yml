name: Deploy to Korea Server

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/Tag/SHA to deploy (default: korea)"
        required: false
        default: "korea"

concurrency:
  group: deploy-korea
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Korea via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 45.93.30.190
          username: root
          port: 22
          key: ${{ secrets.KOREA_SSH_KEY }}
          script: |
            set -e

            # 重要：REF 在这里“直接用 GitHub 表达式”写死进脚本，避免依赖远端环境变量
            REF="${{ github.event.inputs.ref || 'korea' }}"

            echo "== Deploy ref: $REF =="
            cd /root/pdfsearch

            git fetch --all --tags

            # 分支：对齐到 origin/分支；tag/SHA：直接 checkout
            if git show-ref --verify --quiet "refs/remotes/origin/$REF"; then
              git checkout -f "$REF"
              git reset --hard "origin/$REF"
            else
              git checkout -f "$REF"
            fi

            # 同步前端到 Nginx 站点目录（主页更新靠这一步）
            command -v rsync >/dev/null 2>&1 || (apt-get update -y && apt-get install -y rsync)
            mkdir -p /var/www/gfwzb.com
            rsync -a --delete /root/pdfsearch/site_frontend/ /var/www/gfwzb.com/
            chmod -R 755 /var/www/gfwzb.com

            # 后端依赖与重启
            source venv/bin/activate
            pip install --no-cache-dir -r requirements.txt
            deactivate

            systemctl restart pdfsearch
            systemctl reload nginx || systemctl restart nginx || true

            echo "== done =="
